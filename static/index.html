<!DOCTYPE html>
<html>
<head>
  <title>iOS Manual Control</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: #222;
    }
    .buttons {
      margin: 10px;
      text-align: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      z-index: 10;
    }
    #stream-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #stream {
      border: 2px solid #ccc;
      background: #000;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="buttons">
    <button onclick="startSession()">Start Session</button>
    <button onclick="endSession()">End Session</button>
  </div>
  <div id="stream-container"></div>
  <script>
    const streamContainer = document.getElementById("stream-container");
    window.deviceWidth = 375;
    window.deviceHeight = 812;

    function fetchDeviceInfo() {
      return fetch('/device_info')
        .then(response => response.json())
        .then(data => {
          if (data.width && data.height) {
            window.deviceWidth = data.width;
            window.deviceHeight = data.height;
          }
        })
        .catch(err => console.error("Failed to fetch device dimensions:", err));
    }

    function startSession() {
      fetchDeviceInfo().then(() => {
        fetch('/start_session', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              loadStream();
            } else {
              alert('Error: ' + data.message);
            }
          })
          .catch(err => console.error("Error starting session:", err));
      });
    }

    function endSession() {
      fetch('/end_session', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            unloadStream();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(err => console.error("Error ending session:", err));
    }

    function loadStream() {
      unloadStream();
      const stream = document.createElement("img");
      stream.id = "stream";
      stream.src = "/stream";
      stream.alt = "Device Screen Stream";
      // Set image size to match device logical screen size (px)
      stream.style.width = window.deviceWidth + "px";
      stream.style.height = window.deviceHeight + "px";
      streamContainer.appendChild(stream);
      stream.onload = function() {
        // Log information about the image dimensions for debugging
        console.log(`Device dimensions: ${window.deviceWidth}x${window.deviceHeight}`);
        console.log(`Image natural dimensions: ${stream.naturalWidth}x${stream.naturalHeight}`);
        console.log(`Image styled dimensions: ${stream.style.width} x ${stream.style.height}`);
        console.log(`Image actual displayed dimensions: ${stream.getBoundingClientRect().width}x${stream.getBoundingClientRect().height}`);
        
        stream.addEventListener("click", handleTouch);
      };
    }

    function unloadStream() {
      const stream = document.getElementById("stream");
      if (stream) {
        stream.removeEventListener("click", handleTouch);
        streamContainer.removeChild(stream);
      }
    }

    function handleTouch(event) {
      const stream = event.target;
      const rect = stream.getBoundingClientRect();
      
      // Click position in rendered image (browser coordinates)
      const browserX = Math.round(event.clientX - rect.left);
      const browserY = Math.round(event.clientY - rect.top);
      
      // Get actual displayed dimensions of the image
      const displayedWidth = rect.width;
      const displayedHeight = rect.height;
      
      // Calculate scale factors to convert from displayed size to device size
      const scaleX = window.deviceWidth / displayedWidth;
      const scaleY = window.deviceHeight / displayedHeight;
      
      // Apply scaling to convert browser coordinates to device coordinates
      const deviceX = Math.round(browserX * scaleX);
      const deviceY = Math.round(browserY * scaleY);
      
      // Ensure coordinates are within device bounds
      const clampedX = Math.max(0, Math.min(deviceX, window.deviceWidth - 1));
      const clampedY = Math.max(0, Math.min(deviceY, window.deviceHeight - 1));
      
      console.log(`Browser click: (${browserX}, ${browserY}), Display size: ${displayedWidth}x${displayedHeight}, Device size: ${window.deviceWidth}x${window.deviceHeight}, Scale: (${scaleX.toFixed(3)}, ${scaleY.toFixed(3)}), Device coords: (${clampedX}, ${clampedY})`);
      
      fetch('/tap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ x: clampedX, y: clampedY })
      })
        .then(response => response.json())
        .then(data => console.log("Tap response:", data))
        .catch(err => console.error("Error during tap:", err));
    }

    // On load, fetch device info
    fetchDeviceInfo();
  </script>
</body>
</html>
